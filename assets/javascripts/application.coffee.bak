jQuery ->
  API_URL = '/assets/javascripts/'
  QUESTIONS = {}
  
  # Helpers
  
  firstNumberAfterDelimiter = (string, delimiter = '_') ->
    string.substring(string.indexOf(delimiter) + 1, string.length)
  
  # Application-specific
  
  getQuestions = ->
    SERVICE = 'questions'
    
    $.ajax
      url: "#{API_URL}#{SERVICE}.json"
      dataType: 'json',
      success: (data) ->
        QUESTIONS = data
  
  getQuestions()
  
  buildExplanationList = (question_id, answer_id) ->
    # fake return from an ajax call for question_id's explanations
    answers =
      1: [ "I'm starting my own company.", "I'm freelancing.", "I'm consulting." ],
      2: [ "I'm an undergraduate.", "I'm persuing my master's degree.", "I'm in high school." ],
      3: [ "I'm a bum.", "I'm between jobs.", "I live in my parent's basement." ]
    
    selected_answer = answers[answer_id]
    explanation_list = $('<ul class="explanations">')
    
    for explanation in selected_answer
      explanation_list.append $('<li>').append $("<a href='#'>").text explanation
    
    explanation_list.append $("<li><input name='question_#{question_id}_answer_#{answer_id}_explanation' placeholder='Enter your own explanation'></li>")
  
  buildQuestion = (question_id) ->
    # get the correct question
    for question in QUESTIONS['questions']
      if question.id is question_id
        next_question = question
        break
    
    question =
      """
      <div id="question_#{question_id}" class="questions">
        <h3>#{next_question.text}</h3>
        <ul class="answers">
      """
    
    for answer in next_question.answers
      question += "<li><a href='#' class='button'>#{answer.text}</a></li>"
    
    question += 
      """
      <div class="question_actions">
        <a href="#" class="button skip">Skip</a>
      </div>
      """
    
    $(question)
  
  showExplanationListForLinkObject = (link) ->
    question_id = firstNumberAfterDelimiter(link.parent().parent().parent().attr('id'))
    answer_id = firstNumberAfterDelimiter(link.attr('href'), '#')
    current_explanation_list = link.parent().parent().parent().find('.explanations')
    
    # hide and remove current explanations
    if current_explanation_list.length
      current_explanation_list.slideUp ->
        current_explanation_list.remove()
    
    explanation_list = $(buildExplanationList question_id, answer_id)
    
    link.parent().parent().after(explanation_list)
    explanation_list.slideDown()
  
  $('.question .skip').click (e) ->
    e.preventDefault()
    link = $(@)
    question = link.parent().parent().parent()
    next_question_id = parseInt(firstNumberAfterDelimiter(link.attr('href')), 10) + 1
    
    console.log buildQuestion(next_question_id)
    
    question.find('.explanations').slideUp ->
      question.find('.selected').removeClass('selected')
      $(@).remove()
  
  $('.question .answers a').click (e) ->
    e.preventDefault()
    link = $(@)
    
    if not link.hasClass('selected')
      # remove the selected class from other answers
      link.parent().parent().find('.selected').removeClass('selected')
      
      link.addClass('selected')
      showExplanationListForLinkObject(link)
  
  $('dt .disclosure').click (e) ->
    e.preventDefault()
    
    link = $(@)
    dd = link.parent().next()
    
    if link.hasClass 'fade'
      dd.fadeToggle()
    else
      dd.slideToggle()
